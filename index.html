<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/bootstrap.min.css">
    <link rel="stylesheet" href="assets/style.css">

    <title>CST3145 Coursework 1 <br> VueJS Web Application</title>

    <script src="assets/bootstrap.bundle.min.js"></script>
    <script src="assets/vue.js"></script>
    <script src="assets/lessons.js"></script>
</head>

<body>
    <div id="WebApp">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg bg-light">
            <div class="container">
                <a class="navbar-brand text-success" href="index.html">{{ title }}</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <button @click="toggleCart" class="btn btn-success"
                                :disabled="cart.length === 0">Cart</button>
                        </li>
                    </ul>
                    <form class="d-flex" role="search">
                        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search" v-model="searchQuery" @input="searchLessons">
                        <button class="btn btn-outline-success" type="submit">Search</button>
                    </form>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="lessons" v-if="showCart">
                <br>
                <h3>Lessons List</h3>
                <div>
                    <label>Sort:</label>
                    <select v-model="sortCriteria">
                        <option value="name">Name</option>
                        <option value="price">Price</option>
                        <option value="location">Location</option>
                        <option value="spaces">Spaces Available</option>
                    </select>
                    <select v-model="sortOrder">
                        <option value="asc">Ascending</option>
                        <option value="desc">Descending</option>
                    </select>
                </div>

                <!-- Display lessons -->
                <div class="row">
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12 mt-3" v-for="lesson in sortedLessons" :key="lesson.id">
                        <div class="lessons-box">
                            <img :src="lesson.LessonImg" alt="Lesson Image" style="width: 50px; height: 50px;">
                            <p>
                                
                                <b style="font-size: 18px;">{{ lesson.LessonName }}</b> <br>
                                <b>Price: £{{ lesson.LessonPrice }}</b><br>
                                
                                <!-- Check if LessonSpace is greater than 0 -->
                                <div class="clearfix" style="margin-top: -15px;"></div>  
                                <span v-if="lesson.LessonSpace > 0">
                                    <p style="margin: 0 0 5px 0;"><b>Space: {{ lesson.LessonSpace }} {{ lesson.LessonSpace <= 5 ? 'left' : '' }}</b></p>
                                    <div class="clearfix"></div>    
                                    <button @click="addToCart(lesson)" class="btn btn-success">Add to Cart</button> 
                                    
                                </span>
                                
                                <span v-else>  
                                    <b>Out of Stock</b> 
                                    <div class="clearfix"></div>  <br>
                                    <button :disabled="true" class="btn btn-secondary">Add to Cart</button> 
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shopping Cart section -->
            <div class="cart" v-else>
                <br>
                <h3 class="text-center">Shopping Cart</h3>
                
                <ul class="cart-item">
                    <li v-for="item in cart" :key="item.id">
                        <h5>{{ item.LessonName }} in £{{ item.LessonPrice }}</h5>
                        <h5 class="mt-1 mb-2">Spaces: {{ item.LessonSpace }}</h5>
                        <button @click="decrementQty(item)" class="btn btn-secondary">-</button>
                        <button @click="incrementQty(item)" class="btn btn-secondary">+</button>
                        <button @click="removeFromCart(item)" class="btn btn-danger">Remove</button>
                    </li>
                </ul>

                
                <h3 class="mt-2">Total Price: £{{ total }}</h3>
                
                
                <div class="user-dets">
                    <h3>User Details</h3>
                    <div class="mt-3" style="max-width: 520px;">
                        <label for="username">Username:</label>
                        <input type="text" id="username" class="form-control" v-model="username">
                        <label for="contact">Contact:</label>
                        <input type="text" id="contact"  class="form-control" v-model="contact">
                    </div>
                    
                    <h5>Order Details:</h5>
                    Username: <b>{{ username }}</b><br>
                    Phone: <b>{{ contact }}</b><br>
                    Total Items in cart: <b> {{ totalItemsInCart }}</b><br>
                    Total Amount: <b>£{{ total }}</b>
                </div>
            </div>
        </div>
    </div>


    <script>
        var WebApp = new Vue({
            el: '#WebApp',
            data: {
                title: 'Vue Web Based Mobile App',
                lessons: Lessons,
                cart: [],
                total: 0,
                showCart: true,
                username: '',
                contact: '',
                sortCriteria: 'name',
                sortOrder: 'asc',
                searchQuery: '',
            },
            methods: {
                  // add lesson 
                addToCart(lesson) {
                    const existingIndex = this.cart.findIndex(item => item.id === lesson.id);

                    if (lesson.LessonSpace > 0) {
                          // check lesson already cart, 
                        if (existingIndex !== -1) {
                              // increase LessonSpace;
                            this.cart[existingIndex].LessonSpace++;
                        } else {
                              // add to cart
                            this.cart.push({
                                id: lesson.id,
                                LessonName: lesson.LessonName,
                                LessonPrice: lesson.LessonPrice,
                                LessonSpace: 1,
                            });
                        }

                          // decrease LessonSpace lesson
                        lesson.LessonSpace--;

                          // total amount of cart
                        this.calculateTotal();
                    }
                },
                  // remove lesson
                removeFromCart(item) {
                    const existingIndex = this.cart.findIndex(cartItem => cartItem.id === item.id);

                    if (existingIndex !== -1) {
                          // Remove item cart
                        this.cart.splice(existingIndex, 1);
                          // reverting LessonSpace
                        this.lessons.find(lesson => lesson.id === item.id).LessonSpace += item.LessonSpace;

                          // total amount updates
                        this.calculateTotal();
                    }
                },
                  // increase spaces in cart
                incrementQty(item) {
                    const lesson = this.lessons.find(lesson => lesson.id === item.id);

                    if (lesson) {
                          // increase and decrease lessons
                        item.LessonSpace++;
                        lesson.LessonSpace--;

                          // Reverting if LessonSpace becomes deduction
                        if (lesson.LessonSpace < 0) {
                            item.LessonSpace--;
                            lesson.LessonSpace++;
                        }

                          // Recalculate the total amount in cart
                        this.calculateTotal();
                    }
                },
                  // decrease spaces in cart
                decrementQty(item) {
                    const lesson = this.lessons.find(lesson => lesson.id === item.id);

                    if (lesson && item.LessonSpace > 1) {
                          // decrease and increase lesson spaces
                        item.LessonSpace--;
                        lesson.LessonSpace++;

                          // Recalculate the total amount in cart
                        this.calculateTotal();
                    }
                },
                  // total amount in cart
                calculateTotal() {
                    this.total = this.cart.reduce((acc, item) => acc + item.LessonPrice, 0);
                },
                  // toggle Lessons and Cart 
                toggleCart() {
                    if (this.cart.length > 0) {
                        this.showCart = !this.showCart;
                    }
                },
                  // Sorting
                sortItems(items) {
                    const key = this.sortCriteria;
                    const order = this.sortOrder === 'asc' ? 1 : -1;

                    return items.slice().sort((a, b) => {
                        const valueA = key === 'name' ? a.LessonName : key === 'price' ? a.LessonPrice : key === 'location' ? a.LessonLocation : a.LessonSpace;
                        const valueB = key === 'name' ? b.LessonName : key === 'price' ? b.LessonPrice : key === 'location' ? b.LessonLocation : b.LessonSpace;

                        if (valueA < valueB) return -1 * order;
                        if (valueA > valueB) return 1 * order;
                        return 0;
                    });
                },
                searchLessons() {
                    const query = this.searchQuery.toLowerCase();
                    this.sortedLessons = this.lessons.filter(lesson =>
                        lesson.LessonName.toLowerCase().includes(query) ||
                        lesson.LessonLocation.toLowerCase().includes(query)
                    );
                },
            },
            computed: {
                  // total number items cart
                totalItemsInCart() {
                    return this.cart.length;
                },
                sortedLessons() {
                    return this.sortItems(this.filteredLessons);
                },
                filteredLessons() {
                    const query = this.searchQuery.toLowerCase();
                    return this.lessons.filter(lesson =>
                        lesson.LessonName.toLowerCase().includes(query) ||
                        lesson.LessonLocation.toLowerCase().includes(query)
                    );
                },
            }
        });
    </script>
</body>

</html>